---
- name: Check for Init done events
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Extract individual resources from ev
      set_fact:
        individual_resources: "{{ ev.resources.items }}"

    - name: Debug - Show all resources
      debug:
        var: individual_resources

    - name: Filter resources where metadata label type is 'eda'
      set_fact:
        filtered_resources_without_ev: "{{ individual_resources | selectattr('metadata.labels', 'defined') | selectattr('metadata.labels.type', 'defined') | selectattr('metadata.labels.type', 'eq', 'eda') | list }}"

    - name: Restructure resources with event.resource hierarchy
      set_fact:
        filtered_resources: "{{ filtered_resources_without_ev | map('ansible.builtin.combine', {'event': {'type': 'ADDED', 'resource': {}}}) | map('ansible.builtin.combine', {'event': {'resource': item}}, recursive=true) | list }}"

    - name: Debug - Show restructured resources
      debug:
        var: filtered_resources

    - name: Extract the annotations of the filtered resources
      set_fact:
        filtered_resource_annotations: "{{ filtered_resources | map(attribute='event.resource.metadata.annotations') | list }}"

    - name: Call k8s_create_virtual_network role for each filtered resource
      include_role:
        name: k8s_create_virtual_network
      vars:
        ns: "{{ item.event.resource.metadata.name }}"
        annotate: "{{ item.event.resource.metadata.annotations }}"
        ev: "{{ item.event }}"
      loop: "{{ filtered_resources }}"
      loop_control:
        loop_var: item